<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API æµ‹è¯•é¡µé¢ - æ— éšœç¢AIæ•™å­¦å¹³å°</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px; margin: 0 auto; padding: 20px;
      background: #f5f5f5; color: #333;
    }
    h1 { color: #1976d2; margin-bottom: 20px; }
    h2 { margin: 20px 0 10px; color: #555; }
    .card {
      background: white; border-radius: 8px; padding: 20px;
      margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 14px; }
    .status.ok { background: #e8f5e9; color: #2e7d32; }
    .status.error { background: #ffebee; color: #c62828; }
    .status.loading { background: #fff3e0; color: #ef6c00; }
    input[type="text"] {
      width: 100%; padding: 12px; border: 1px solid #ddd;
      border-radius: 6px; font-size: 16px; margin: 10px 0;
    }
    button {
      background: #1976d2; color: white; border: none;
      padding: 12px 24px; border-radius: 6px; cursor: pointer;
      font-size: 16px; margin-right: 10px; margin-top: 10px;
    }
    button:hover { background: #1565c0; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .log {
      background: #263238; color: #aed581; padding: 15px;
      border-radius: 6px; font-family: monospace; font-size: 13px;
      max-height: 300px; overflow-y: auto; white-space: pre-wrap;
    }
    .log .error { color: #ef5350; }
    .log .success { color: #66bb6a; }
    .log .info { color: #42a5f5; }
    .log .warn { color: #ffa726; }
    .section { margin: 30px 0; }
    .quick-links { margin: 20px 0; }
    .quick-links a {
      display: inline-block; margin-right: 15px; color: #1976d2;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª API æµ‹è¯•é¡µé¢</h1>

  <div class="quick-links">
    <span>å¿«é€Ÿè®¿é—®ï¼š</span>
    <a href="http://localhost:3001/health" target="_blank">åç«¯å¥åº·æ£€æŸ¥</a>
    <a href="http://localhost:8001/docs" target="_blank">bilibili-subtitle API æ–‡æ¡£</a>
  </div>

  <!-- æœåŠ¡çŠ¶æ€ -->
  <div class="section">
    <h2>ğŸ“Š æœåŠ¡çŠ¶æ€</h2>
    <div class="card">
      <p>Express åç«¯ (3001): <span id="backend-status" class="status loading">æ£€æŸ¥ä¸­...</span></p>
      <p>bilibili-subtitle (8001): <span id="subtitle-status" class="status loading">æ£€æŸ¥ä¸­...</span></p>
      <p>bili_text (8000): <span id="bili-status" class="status loading">æ£€æŸ¥ä¸­...</span></p>
    </div>
  </div>

  <!-- å­—å¹•æå–æµ‹è¯• -->
  <div class="section">
    <h2>ğŸ“ å­—å¹•æå–æµ‹è¯•</h2>
    <div class="card">
      <label>Bç«™è§†é¢‘URL:</label>
      <input type="text" id="video-url" placeholder="https://www.bilibili.com/video/BV1xxx/"
             value="https://www.bilibili.com/video/BV1ps4y1Q7Yy/">
      <button onclick="extractSubtitle()" id="extract-btn">æå–å­—å¹•</button>
      <button onclick="testAll()">ä¸€é”®æµ‹è¯•å…¨éƒ¨</button>
      <div id="extract-result" style="margin-top: 15px;"></div>
    </div>
  </div>

  <!-- è§†é¢‘åˆ†ææµ‹è¯• -->
  <div class="section">
    <h2>ğŸ” å®Œæ•´è§†é¢‘åˆ†ææµ‹è¯•</h2>
    <div class="card">
      <label>Bç«™è§†é¢‘URL:</label>
      <input type="text" id="analyze-url" placeholder="https://www.bilibili.com/video/BV1xxx/"
             value="https://www.bilibili.com/video/BV1ps4y1Q7Yy/">
      <button onclick="analyzeVideo()" id="analyze-btn">å¼€å§‹åˆ†æ</button>
      <div id="analyze-result" style="margin-top: 15px;"></div>
    </div>
  </div>

  <!-- æ—¥å¿—è¾“å‡º -->
  <div class="section">
    <h2>ğŸ“‹ æ‰§è¡Œæ—¥å¿—</h2>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    <div class="log" id="log"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3001';

    // æ—¥å¿—å‡½æ•°
    function log(msg, type = 'info') {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML += `<span class="${type}">[${time}] ${msg}</span>\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    function clearLog() { document.getElementById('log').innerHTML = ''; }

    // æ£€æŸ¥æœåŠ¡çŠ¶æ€
    async function checkServices() {
      const services = [
        { id: 'backend-status', url: `${API_BASE}/health`, name: 'Express åç«¯' },
        { id: 'subtitle-status', url: 'http://localhost:8001/health', name: 'bilibili-subtitle' },
        { id: 'bili-status', url: 'http://localhost:8000/health', name: 'bili_text' }
      ];

      for (const s of services) {
        try {
          const res = await fetch(s.url, { timeout: 3000 });
          const el = document.getElementById(s.id);
          if (res.ok) {
            el.textContent = 'âœ“ è¿è¡Œä¸­';
            el.className = 'status ok';
          } else {
            el.textContent = 'âœ— å¼‚å¸¸';
            el.className = 'status error';
          }
        } catch {
          const el = document.getElementById(s.id);
          el.textContent = 'âœ— æœªè¿è¡Œ';
          el.className = 'status error';
        }
      }
    }

    // æå–å­—å¹•
    async function extractSubtitle() {
      const url = document.getElementById('video-url').value;
      const btn = document.getElementById('extract-btn');
      const result = document.getElementById('extract-result');

      if (!url) { log('è¯·è¾“å…¥è§†é¢‘URL', 'error'); return; }

      btn.disabled = true;
      result.innerHTML = '<p class="loading">æå–ä¸­...</p>';
      log(`å¼€å§‹æå–å­—å¹•: ${url}`, 'info');

      try {
        log('è°ƒç”¨ bilibili-subtitle æœåŠ¡...', 'info');
        const res = await fetch(`${API_BASE}/api/gateway/subtitle`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ videoUrl: url })
        });

        const data = await res.json();
        log(`å“åº”çŠ¶æ€: ${res.status}`, data.success ? 'success' : 'error');

        if (data.success && data.data) {
          const d = data.data;
          const subtitleCount = d.subtitle_srt ? d.subtitle_srt.split('\n\n').length : 0;
          result.innerHTML = `
            <p class="success">âœ“ æå–æˆåŠŸ!</p>
            <p>æ¥æº: ${d.source === 'bilibili' ? 'Bç«™å®˜æ–¹å­—å¹•' : 'FunASRè½¬å½•'}</p>
            <p>å­—å¹•æ¡æ•°: ${subtitleCount}</p>
            <p>å­—å¹•é¢„è§ˆ:</p>
            <pre style="background:#f5f5f5;padding:10px;overflow:auto;max-height:200px;">${d.subtitle_srt?.slice(0, 500)}...</pre>
          `;
          log(`å­—å¹•æå–æˆåŠŸï¼Œæ¥æº: ${d.source}ï¼Œæ¡æ•°: ${subtitleCount}`, 'success');
        } else {
          result.innerHTML = `<p class="error">âœ— å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
          log(`å­—å¹•æå–å¤±è´¥: ${data.message}`, 'error');
        }
      } catch (e) {
        result.innerHTML = `<p class="error">âœ— ç½‘ç»œé”™è¯¯: ${e.message}</p>`;
        log(`ç½‘ç»œé”™è¯¯: ${e.message}`, 'error');
      }

      btn.disabled = false;
    }

    // è§†é¢‘åˆ†æ
    async function analyzeVideo() {
      const url = document.getElementById('analyze-url').value;
      const btn = document.getElementById('analyze-btn');
      const result = document.getElementById('analyze-result');

      if (!url) { log('è¯·è¾“å…¥è§†é¢‘URL', 'error'); return; }

      btn.disabled = true;
      result.innerHTML = '<p class="loading">åˆ†æä¸­ï¼ˆå¯èƒ½éœ€è¦1-3åˆ†é’Ÿï¼‰...</p>';
      log(`å¼€å§‹è§†é¢‘åˆ†æ: ${url}`, 'info');

      try {
        log('æäº¤åˆ†æä»»åŠ¡...', 'info');
        const res = await fetch(`${API_BASE}/api/gateway/bilibili/analyze`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            url,
            options: {
              audio_transcription: false,
              visual_analysis: 'all',
              frame_interval: 2.0
            }
          })
        });

        const data = await res.json();
        log(`ä»»åŠ¡æäº¤å“åº”: ${JSON.stringify(data)}`, data.success ? 'success' : 'error');

        if (data.success && data.data) {
          const taskId = data.data.taskId;
          result.innerHTML = `<p class="loading">ä»»åŠ¡å·²åˆ›å»ºï¼ŒID: ${taskId}<br>æ­£åœ¨ç­‰å¾…åˆ†æå®Œæˆ...</p>`;
          log(`ä»»åŠ¡ID: ${taskId}ï¼Œè½®è¯¢çŠ¶æ€...`, 'info');

          // è½®è¯¢çŠ¶æ€
          let attempts = 0;
          const maxAttempts = 90; // 3åˆ†é’Ÿ
          while (attempts < maxAttempts) {
            await new Promise(r => setTimeout(r, 2000));
            attempts++;

            try {
              const statusRes = await fetch(`${API_BASE}/api/gateway/bilibili/tasks/${taskId}/status`);
              const statusData = await statusRes.json();

              if (statusData.success && statusData.data) {
                const s = statusData.data;
                log(`çŠ¶æ€: ${s.status}, è¿›åº¦: ${s.progress}%`, 'info');
                result.innerHTML = `<p>çŠ¶æ€: ${s.status}<br>è¿›åº¦: ${s.progress}%<br>${s.message || ''}</p>`;

                if (s.status === 'completed') {
                  const resultRes = await fetch(`${API_BASE}/api/gateway/bilibili/tasks/${taskId}/result`);
                  const resultData = await resultRes.json();

                  if (resultData.success && resultData.data) {
                    const r = resultData.data;
                    const visualCount = r.visual_content?.length || 0;
                    const sceneCount = r.scene_descriptions?.length || 0;
                    result.innerHTML = `
                      <p class="success">âœ“ åˆ†æå®Œæˆ!</p>
                      <p>ç”»é¢æ–‡å­—: ${visualCount} æ¡</p>
                      <p>åœºæ™¯æè¿°: ${sceneCount} æ¡</p>
                      <p>æ€»ç»“: ${r.summary?.slice(0, 200)}...</p>
                    `;
                    log(`åˆ†æå®Œæˆ! è§†è§‰å†…å®¹: ${visualCount}, åœºæ™¯: ${sceneCount}`, 'success');
                  }
                  break;
                } else if (s.status === 'failed') {
                  result.innerHTML = '<p class="error">âœ— åˆ†æå¤±è´¥</p>';
                  log('åˆ†æå¤±è´¥', 'error');
                  break;
                }
              }
            } catch (e) {
              log(`è½®è¯¢é”™è¯¯: ${e.message}`, 'warn');
            }
          }

          if (attempts >= maxAttempts) {
            result.innerHTML += '<p class="warn">â° ç­‰å¾…è¶…æ—¶ï¼Œè¯·ç¨åæŸ¥è¯¢çŠ¶æ€</p>';
            log('ç­‰å¾…è¶…æ—¶', 'warn');
          }
        } else {
          result.innerHTML = `<p class="error">âœ— ä»»åŠ¡åˆ›å»ºå¤±è´¥: ${data.message}</p>`;
          log(`ä»»åŠ¡åˆ›å»ºå¤±è´¥: ${data.message}`, 'error');
        }
      } catch (e) {
        result.innerHTML = `<p class="error">âœ— ç½‘ç»œé”™è¯¯: ${e.message}</p>`;
        log(`ç½‘ç»œé”™è¯¯: ${e.message}`, 'error');
      }

      btn.disabled = false;
    }

    // ä¸€é”®æµ‹è¯•
    async function testAll() {
      clearLog();
      log('========== ä¸€é”®æµ‹è¯•å¼€å§‹ ==========', 'info');
      await checkServices();
      log('æœåŠ¡çŠ¶æ€æ£€æŸ¥å®Œæˆ', 'info');

      log('---------- å­—å¹•æå–æµ‹è¯• ----------', 'info');
      await extractSubtitle();
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡çŠ¶æ€
    checkServices();
    setInterval(checkServices, 10000); // æ¯10ç§’åˆ·æ–°
  </script>
</body>
</html>
