# 字幕生成API修复 - 任务清单

## 状态说明
- ✅ 已完成
- 🔄 进行中
- ⏸️ 待开始
- ❌ 已取消

---

## 阶段1: 问题诊断 ✅

### Task 1.1: 验证后端服务状态 ✅
**负责人**: AI Assistant  
**优先级**: P0  
**预计时间**: 10分钟  

**完成标准**:
- [x] 后端服务在端口3001运行
- [x] `/health` 端点返回200
- [x] `/api/subtitles/jobs` 端点可访问

**结果**: 
- 后端服务正常运行
- API端点工作正常
- 任务创建成功返回202状态码

---

### Task 1.2: 诊断STT服务连接问题 ✅
**负责人**: AI Assistant  
**优先级**: P0  
**预计时间**: 5分钟  

**完成标准**:
- [x] 识别连接错误原因
- [x] 确认STT服务未运行

**结果**:
- 错误: `ECONNREFUSED 127.0.0.1:9977`
- 原因: 本地STT服务未启动
- 环境变量: `USE_LOCAL_STT=true`

---

## 阶段2: 快速修复方案 🔄

### Task 2.1: 检查现有STT服务脚本 ⏸️
**负责人**: 开发者  
**优先级**: P0  
**预计时间**: 15分钟  

**任务描述**:
检查项目中是否已有STT服务实现

**完成标准**:
- [ ] 检查 `stt_api_service.py` 文件
- [ ] 检查 `server/src/scripts/whisper_local.py`
- [ ] 确认脚本是否可用
- [ ] 记录所需依赖

**执行步骤**:
```bash
# 检查文件
ls -la stt_api_service.py
ls -la server/src/scripts/whisper_local.py

# 查看内容
cat stt_api_service.py
```

---

### Task 2.2: 选择修复方案 ⏸️
**负责人**: 开发者  
**优先级**: P0  
**预计时间**: 5分钟  

**方案选择**:

**方案A: 启动本地STT服务 (推荐)**
- 优势: 利用CUDA加速,无API费用
- 前提: Python环境配置完成
- 时间: 30-60分钟

**方案B: 切换到OpenAI API (快速)**
- 优势: 立即可用
- 前提: OpenAI API Key有效
- 时间: 5分钟

**方案C: 改进错误处理 (临时)**
- 优势: 提供更好的用户体验
- 前提: 无
- 时间: 20分钟

**完成标准**:
- [ ] 选择一个方案
- [ ] 记录选择理由

---

## 阶段3A: 本地STT服务方案

### Task 3A.1: 安装Python依赖 ⏸️
**负责人**: 开发者  
**优先级**: P1  
**预计时间**: 20分钟  

**任务描述**:
安装faster-whisper和相关依赖

**完成标准**:
- [ ] Python 3.8+ 已安装
- [ ] pip 已更新
- [ ] 安装 faster-whisper
- [ ] 安装 Flask/FastAPI
- [ ] 验证CUDA可用

**执行步骤**:
```bash
# 检查Python版本
python --version

# 安装依赖
pip install faster-whisper flask flask-cors

# 验证CUDA
python -c "import torch; print(torch.cuda.is_available())"
```

---

### Task 3A.2: 创建STT服务脚本 ⏸️
**负责人**: AI Assistant  
**优先级**: P1  
**预计时间**: 30分钟  

**任务描述**:
创建或修改STT服务脚本

**完成标准**:
- [ ] 创建 `stt_service.py`
- [ ] 实现 `/api` 端点
- [ ] 支持multipart/form-data
- [ ] 返回SRT格式字幕
- [ ] 使用CUDA加速

**文件位置**: `server/stt_service.py`

---

### Task 3A.3: 启动STT服务 ⏸️
**负责人**: 开发者  
**优先级**: P1  
**预计时间**: 10分钟  

**任务描述**:
启动并验证STT服务

**完成标准**:
- [ ] 服务运行在端口9977
- [ ] 可以接收POST请求
- [ ] 返回正确的响应格式
- [ ] 日志输出正常

**执行步骤**:
```bash
# 启动服务
cd server
python stt_service.py

# 测试服务 (另一个终端)
curl -X POST http://127.0.0.1:9977/api \
  -F "file=@test.mp3" \
  -F "language=zh" \
  -F "model=base" \
  -F "response_format=srt"
```

---

### Task 3A.4: 端到端测试 ⏸️
**负责人**: 开发者  
**优先级**: P1  
**预计时间**: 15分钟  

**任务描述**:
测试完整的字幕生成流程

**完成标准**:
- [ ] 在VideoPlayer中点击"生成字幕"
- [ ] 任务创建成功
- [ ] 任务状态正确更新
- [ ] 字幕内容正确显示
- [ ] 无错误日志

---

## 阶段3B: OpenAI API方案 (快速修复)

### Task 3B.1: 修改环境变量 ⏸️
**负责人**: 开发者  
**优先级**: P0  
**预计时间**: 2分钟  

**任务描述**:
切换到OpenAI API模式

**完成标准**:
- [ ] 修改 `server/.env`
- [ ] 设置 `USE_LOCAL_STT=false`
- [ ] 验证 `OPENAI_API_KEY` 有效

**执行步骤**:
```bash
# 编辑 server/.env
USE_LOCAL_STT=false
OPENAI_API_KEY=sk-proj-xxx  # 确保有效
```

---

### Task 3B.2: 重启后端服务 ⏸️
**负责人**: 开发者  
**优先级**: P0  
**预计时间**: 1分钟  

**任务描述**:
重启后端服务使配置生效

**完成标准**:
- [ ] 停止当前服务
- [ ] 重新启动服务
- [ ] 验证服务正常运行

**执行步骤**:
```bash
# 停止服务 (Ctrl+C)
# 重新启动
cd server
npm run dev
```

---

### Task 3B.3: 测试OpenAI API ⏸️
**负责人**: 开发者  
**优先级**: P0  
**预计时间**: 10分钟  

**任务描述**:
验证OpenAI API字幕生成

**完成标准**:
- [ ] 在VideoPlayer中点击"生成字幕"
- [ ] 任务创建成功
- [ ] 字幕生成成功
- [ ] 字幕内容正确

---

## 阶段3C: 错误处理改进方案

### Task 3C.1: 改进降级逻辑 ⏸️
**负责人**: AI Assistant  
**优先级**: P1  
**预计时间**: 20分钟  

**任务描述**:
改进jobService中的错误处理和降级逻辑

**完成标准**:
- [ ] 修改 `transcribeWithLocalWhisper` 函数
- [ ] 添加OpenAI API降级
- [ ] 添加演示字幕降级
- [ ] 改进错误日志

**文件**: `server/src/services/jobService.ts`

---

### Task 3C.2: 改进前端错误提示 ⏸️
**负责人**: AI Assistant  
**优先级**: P2  
**预计时间**: 15分钟  

**任务描述**:
改进VideoPlayer的错误提示

**完成标准**:
- [ ] 添加错误状态管理
- [ ] 显示友好的错误信息
- [ ] 提供故障排查提示
- [ ] 添加重试按钮

**文件**: `src/components/VideoPlayer.tsx`

---

### Task 3C.3: 添加服务健康检查 ⏸️
**负责人**: AI Assistant  
**优先级**: P2  
**预计时间**: 20分钟  

**任务描述**:
添加STT服务健康检查端点

**完成标准**:
- [ ] 创建 `/api/subtitles/health` 端点
- [ ] 检查STT服务可用性
- [ ] 检查OpenAI API可用性
- [ ] 返回服务状态信息

**文件**: `server/src/controllers/subtitleController.ts`

---

## 阶段4: 文档和部署

### Task 4.1: 更新README ⏸️
**负责人**: AI Assistant  
**优先级**: P2  
**预计时间**: 15分钟  

**任务描述**:
更新项目文档

**完成标准**:
- [ ] 添加字幕生成功能说明
- [ ] 添加环境配置指南
- [ ] 添加故障排查章节
- [ ] 添加本地STT服务启动指南

---

### Task 4.2: 创建启动脚本 ⏸️
**负责人**: AI Assistant  
**优先级**: P2  
**预计时间**: 10分钟  

**任务描述**:
创建一键启动脚本

**完成标准**:
- [ ] 创建 `start-all.bat` (Windows)
- [ ] 创建 `start-all.sh` (Linux/Mac)
- [ ] 同时启动前端、后端、STT服务
- [ ] 添加健康检查

---

### Task 4.3: 添加监控日志 ⏸️
**负责人**: AI Assistant  
**优先级**: P3  
**预计时间**: 20分钟  

**任务描述**:
添加详细的监控和日志

**完成标准**:
- [ ] 添加结构化日志
- [ ] 记录关键指标
- [ ] 添加性能监控
- [ ] 配置日志级别

---

## 阶段5: 优化和增强

### Task 5.1: 添加进度显示 ⏸️
**负责人**: AI Assistant  
**优先级**: P3  
**预计时间**: 30分钟  

**任务描述**:
在前端显示字幕生成进度

**完成标准**:
- [ ] 显示进度条
- [ ] 显示当前状态
- [ ] 显示预计剩余时间
- [ ] 支持取消任务

---

### Task 5.2: 添加字幕缓存 ⏸️
**负责人**: AI Assistant  
**优先级**: P3  
**预计时间**: 30分钟  

**任务描述**:
缓存已生成的字幕

**完成标准**:
- [ ] 实现字幕缓存机制
- [ ] 避免重复生成
- [ ] 支持缓存清理
- [ ] 添加缓存管理界面

---

### Task 5.3: 支持批量生成 ⏸️
**负责人**: AI Assistant  
**优先级**: P3  
**预计时间**: 60分钟  

**任务描述**:
支持批量视频字幕生成

**完成标准**:
- [ ] 支持多视频上传
- [ ] 队列管理
- [ ] 批量进度显示
- [ ] 导出功能

---

## 当前推荐执行顺序

### 立即执行 (快速修复):
1. **Task 3B.1**: 修改环境变量 (2分钟)
2. **Task 3B.2**: 重启后端服务 (1分钟)
3. **Task 3B.3**: 测试OpenAI API (10分钟)

### 后续执行 (完整方案):
1. **Task 2.1**: 检查现有STT服务脚本
2. **Task 3A.1**: 安装Python依赖
3. **Task 3A.2**: 创建STT服务脚本
4. **Task 3A.3**: 启动STT服务
5. **Task 3A.4**: 端到端测试

### 优化改进:
1. **Task 3C.1**: 改进降级逻辑
2. **Task 3C.2**: 改进前端错误提示
3. **Task 4.1**: 更新README

---

## 风险和依赖

### 风险
- OpenAI API Key可能无效或额度不足
- CUDA配置可能有问题
- Python环境可能缺少依赖

### 依赖
- Python 3.8+
- CUDA Toolkit
- FFmpeg
- Node.js后端服务

### 缓解措施
- 提供多种降级方案
- 详细的错误提示
- 完善的文档说明
