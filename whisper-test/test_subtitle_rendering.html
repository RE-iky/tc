<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­—å¹•æ¸²æŸ“æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #666;
            margin-top: 20px;
        }
        video {
            width: 100%;
            max-width: 800px;
            background: #000;
            border-radius: 4px;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-left: 4px solid #2196F3;
            margin: 10px 0;
        }
        .success {
            background: #e8f5e9;
            border-left-color: #4CAF50;
        }
        .error {
            background: #ffebee;
            border-left-color: #f44336;
        }
        .warning {
            background: #fff3e0;
            border-left-color: #ff9800;
        }
        textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¬ å­—å¹•æ¸²æŸ“æµ‹è¯•å·¥å…·</h1>

    <div class="container">
        <h2>æµ‹è¯•è¯´æ˜</h2>
        <div class="info">
            <p><strong>ç›®çš„ï¼š</strong>éªŒè¯SRTå­—å¹•æ˜¯å¦èƒ½æ­£ç¡®æ¸²æŸ“åˆ°HTML5è§†é¢‘ä¸Š</p>
            <p><strong>æµ‹è¯•æ–¹æ³•ï¼š</strong></p>
            <ol>
                <li>ä½¿ç”¨æµ‹è¯•è§†é¢‘å’ŒSRTå­—å¹•æ–‡æœ¬</li>
                <li>å°†SRTæ–‡æœ¬è½¬æ¢ä¸ºBlob URL</li>
                <li>é€šè¿‡&lt;track&gt;å…ƒç´ åŠ è½½åˆ°è§†é¢‘ä¸­</li>
                <li>éªŒè¯å­—å¹•æ˜¯å¦æ˜¾ç¤ºåœ¨è§†é¢‘ç”»é¢ä¸Š</li>
            </ol>
        </div>
    </div>

    <div class="container">
        <h2>æµ‹è¯•1: ä½¿ç”¨é¢„è®¾SRTå­—å¹•</h2>
        <div class="controls">
            <button onclick="loadTestVideo()">åŠ è½½æµ‹è¯•è§†é¢‘</button>
            <button onclick="addSubtitleTrack()">æ·»åŠ å­—å¹•è½¨é“</button>
            <button onclick="removeSubtitleTrack()">ç§»é™¤å­—å¹•è½¨é“</button>
        </div>
        <video id="testVideo" controls>
            <source src="" type="video/mp4">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
        </video>
        <div id="test1Result"></div>
    </div>

    <div class="container">
        <h2>æµ‹è¯•2: ä½¿ç”¨è‡ªå®šä¹‰SRTå­—å¹•</h2>
        <p>åœ¨ä¸‹æ–¹è¾“å…¥SRTæ ¼å¼å­—å¹•ï¼Œç„¶åç‚¹å‡»"åº”ç”¨å­—å¹•"æŒ‰é’®ï¼š</p>
        <textarea id="customSRT" placeholder="ç²˜è´´SRTæ ¼å¼å­—å¹•...">1
00:00:00,000 --> 00:00:05,000
æ¬¢è¿æ¥åˆ°æ— éšœç¢AIæ•™å­¦å¹³å°

2
00:00:05,000 --> 00:00:10,000
æœ¬è§†é¢‘å°†ä»‹ç»äººå·¥æ™ºèƒ½çš„åŸºç¡€æ¦‚å¿µ

3
00:00:10,000 --> 00:00:15,000
äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯</textarea>
        <div class="controls">
            <button onclick="applyCustomSubtitle()">åº”ç”¨å­—å¹•</button>
            <button onclick="validateSRT()">éªŒè¯SRTæ ¼å¼</button>
        </div>
        <div id="test2Result"></div>
    </div>

    <div class="container">
        <h2>æµ‹è¯•3: æ¨¡æ‹Ÿå‰ç«¯å­—å¹•ç”Ÿæˆæµç¨‹</h2>
        <div class="info">
            <p>æ­¤æµ‹è¯•æ¨¡æ‹ŸVideoPlayerç»„ä»¶æ¥æ”¶åˆ°å­—å¹•åçš„å¤„ç†æµç¨‹</p>
        </div>
        <div class="controls">
            <button onclick="simulateFrontendFlow()">æ¨¡æ‹Ÿå‰ç«¯æµç¨‹</button>
        </div>
        <div id="test3Result"></div>
    </div>

    <script>
        let currentSubtitleTrack = null;
        let currentBlobUrl = null;

        // æµ‹è¯•ç”¨çš„SRTå­—å¹•
        const testSRT = `1
00:00:00,000 --> 00:00:05,000
æ¬¢è¿æ¥åˆ°æ— éšœç¢AIæ•™å­¦å¹³å°

2
00:00:05,000 --> 00:00:10,000
æœ¬è§†é¢‘å°†ä»‹ç»äººå·¥æ™ºèƒ½çš„åŸºç¡€æ¦‚å¿µ

3
00:00:10,000 --> 00:00:15,000
äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯

4
00:00:15,000 --> 00:00:20,000
å®ƒè‡´åŠ›äºåˆ›å»ºèƒ½å¤Ÿæ¨¡æ‹Ÿäººç±»æ™ºèƒ½çš„ç³»ç»Ÿ`;

        // åŠ è½½æµ‹è¯•è§†é¢‘
        function loadTestVideo() {
            const video = document.getElementById('testVideo');
            // ä½¿ç”¨ä¸€ä¸ªå…¬å¼€çš„æµ‹è¯•è§†é¢‘URL
            video.src = 'https://www.w3schools.com/html/mov_bbb.mp4';

            showResult('test1Result', 'success', 'âœ“ æµ‹è¯•è§†é¢‘å·²åŠ è½½');
        }

        // æ·»åŠ å­—å¹•è½¨é“
        function addSubtitleTrack() {
            const video = document.getElementById('testVideo');

            if (!video.src) {
                showResult('test1Result', 'error', 'âœ— è¯·å…ˆåŠ è½½æµ‹è¯•è§†é¢‘');
                return;
            }

            // ç§»é™¤æ—§çš„å­—å¹•è½¨é“
            removeSubtitleTrack();

            // å°†SRTæ–‡æœ¬è½¬æ¢ä¸ºBlob
            const blob = new Blob([testSRT], { type: 'text/vtt' });
            const blobUrl = URL.createObjectURL(blob);
            currentBlobUrl = blobUrl;

            // åˆ›å»ºtrackå…ƒç´ 
            const track = document.createElement('track');
            track.kind = 'subtitles';
            track.label = 'ä¸­æ–‡å­—å¹•';
            track.srclang = 'zh';
            track.src = blobUrl;
            track.default = true;

            // æ·»åŠ åˆ°è§†é¢‘
            video.appendChild(track);
            currentSubtitleTrack = track;

            // å¯ç”¨å­—å¹•
            track.addEventListener('load', () => {
                if (video.textTracks.length > 0) {
                    video.textTracks[0].mode = 'showing';
                    showResult('test1Result', 'success', 'âœ“ å­—å¹•è½¨é“å·²æ·»åŠ å¹¶å¯ç”¨ï¼è¯·æ’­æ”¾è§†é¢‘æŸ¥çœ‹å­—å¹•æ•ˆæœ');
                }
            });

            showResult('test1Result', 'info', 'â„¹ æ­£åœ¨åŠ è½½å­—å¹•...');
        }

        // ç§»é™¤å­—å¹•è½¨é“
        function removeSubtitleTrack() {
            if (currentSubtitleTrack) {
                currentSubtitleTrack.remove();
                currentSubtitleTrack = null;
            }
            if (currentBlobUrl) {
                URL.revokeObjectURL(currentBlobUrl);
                currentBlobUrl = null;
            }
            showResult('test1Result', 'info', 'â„¹ å­—å¹•è½¨é“å·²ç§»é™¤');
        }

        // åº”ç”¨è‡ªå®šä¹‰å­—å¹•
        function applyCustomSubtitle() {
            const video = document.getElementById('testVideo');
            const srtText = document.getElementById('customSRT').value;

            if (!video.src) {
                showResult('test2Result', 'error', 'âœ— è¯·å…ˆåŠ è½½æµ‹è¯•è§†é¢‘ï¼ˆæµ‹è¯•1ï¼‰');
                return;
            }

            if (!srtText.trim()) {
                showResult('test2Result', 'error', 'âœ— è¯·è¾“å…¥SRTå­—å¹•å†…å®¹');
                return;
            }

            // ç§»é™¤æ—§çš„å­—å¹•è½¨é“
            removeSubtitleTrack();

            // å°†SRTæ–‡æœ¬è½¬æ¢ä¸ºBlob
            const blob = new Blob([srtText], { type: 'text/vtt' });
            const blobUrl = URL.createObjectURL(blob);
            currentBlobUrl = blobUrl;

            // åˆ›å»ºtrackå…ƒç´ 
            const track = document.createElement('track');
            track.kind = 'subtitles';
            track.label = 'è‡ªå®šä¹‰å­—å¹•';
            track.srclang = 'zh';
            track.src = blobUrl;
            track.default = true;

            // æ·»åŠ åˆ°è§†é¢‘
            video.appendChild(track);
            currentSubtitleTrack = track;

            // å¯ç”¨å­—å¹•
            track.addEventListener('load', () => {
                if (video.textTracks.length > 0) {
                    video.textTracks[0].mode = 'showing';
                    showResult('test2Result', 'success', 'âœ“ è‡ªå®šä¹‰å­—å¹•å·²åº”ç”¨ï¼è¯·æ’­æ”¾è§†é¢‘æŸ¥çœ‹æ•ˆæœ');
                }
            });

            showResult('test2Result', 'info', 'â„¹ æ­£åœ¨åŠ è½½è‡ªå®šä¹‰å­—å¹•...');
        }

        // éªŒè¯SRTæ ¼å¼
        function validateSRT() {
            const srtText = document.getElementById('customSRT').value;

            if (!srtText.trim()) {
                showResult('test2Result', 'error', 'âœ— è¯·è¾“å…¥SRTå­—å¹•å†…å®¹');
                return;
            }

            const lines = srtText.trim().split('\n');
            const errors = [];

            // æ£€æŸ¥åŸºæœ¬ç»“æ„
            if (lines.length < 3) {
                errors.push('å­—å¹•å†…å®¹å¤ªçŸ­ï¼Œä¸ç¬¦åˆSRTæ ¼å¼');
            }

            // æ£€æŸ¥ç¬¬ä¸€è¡Œæ˜¯å¦æ˜¯åºå·
            if (!lines[0].trim().match(/^\d+$/)) {
                errors.push(`ç¬¬ä¸€è¡Œåº”è¯¥æ˜¯åºå·ï¼Œå®é™…å†…å®¹: "${lines[0]}"`);
            }

            // æ£€æŸ¥ç¬¬äºŒè¡Œæ˜¯å¦åŒ…å«æ—¶é—´æˆ³
            if (!lines[1].includes('-->')) {
                errors.push(`ç¬¬äºŒè¡Œåº”è¯¥åŒ…å«æ—¶é—´æˆ³ï¼Œå®é™…å†…å®¹: "${lines[1]}"`);
            }

            if (errors.length > 0) {
                showResult('test2Result', 'error', 'âœ— SRTæ ¼å¼éªŒè¯å¤±è´¥ï¼š<br>' + errors.join('<br>'));
            } else {
                const subtitleCount = (srtText.match(/\n\n/g) || []).length + 1;
                showResult('test2Result', 'success', `âœ“ SRTæ ¼å¼éªŒè¯é€šè¿‡ï¼å­—å¹•å—æ•°é‡: ${subtitleCount}`);
            }
        }

        // æ¨¡æ‹Ÿå‰ç«¯æµç¨‹
        function simulateFrontendFlow() {
            const resultDiv = document.getElementById('test3Result');
            resultDiv.innerHTML = '<div class="info"><strong>æ¨¡æ‹Ÿæµç¨‹ï¼š</strong></div>';

            const steps = [
                { step: 1, desc: 'å‰ç«¯è°ƒç”¨ POST /api/subtitles/jobs', status: 'success' },
                { step: 2, desc: 'åç«¯åˆ›å»ºä»»åŠ¡å¹¶è¿”å› jobId', status: 'success' },
                { step: 3, desc: 'å‰ç«¯è½®è¯¢ GET /api/subtitles/jobs/{jobId}', status: 'success' },
                { step: 4, desc: 'åç«¯è¿”å› SRT å­—å¹•æ–‡æœ¬', status: 'success' },
                { step: 5, desc: 'å‰ç«¯å­˜å‚¨å­—å¹•åˆ° generatedSubtitle çŠ¶æ€', status: 'success' },
                { step: 6, desc: 'å‰ç«¯æ˜¾ç¤ºå­—å¹•ä¸ºæ–‡å­—ç¨¿ï¼ˆå½“å‰å®ç°ï¼‰', status: 'warning' },
                { step: 7, desc: 'âŒ ç¼ºå¤±ï¼šå°† SRT è½¬æ¢ä¸º Blob URL', status: 'error' },
                { step: 8, desc: 'âŒ ç¼ºå¤±ï¼šæ·»åŠ åˆ° <track> å…ƒç´ ', status: 'error' },
                { step: 9, desc: 'âŒ ç¼ºå¤±ï¼šå­—å¹•æ¸²æŸ“åˆ°è§†é¢‘ç”»é¢ä¸Š', status: 'error' }
            ];

            steps.forEach(({ step, desc, status }) => {
                const className = status === 'success' ? 'success' :
                                 status === 'warning' ? 'warning' : 'error';
                const icon = status === 'success' ? 'âœ“' :
                            status === 'warning' ? 'âš ' : 'âœ—';

                resultDiv.innerHTML += `
                    <div class="test-result ${className}">
                        ${icon} æ­¥éª¤${step}: ${desc}
                    </div>
                `;
            });

            resultDiv.innerHTML += `
                <div class="info" style="margin-top: 20px;">
                    <strong>ç»“è®ºï¼š</strong><br>
                    é—®é¢˜å®šä½ï¼šå‰ç«¯æ¥æ”¶åˆ°SRTå­—å¹•åï¼Œåªæ˜¯å°†å…¶æ˜¾ç¤ºä¸ºæ–‡å­—ç¨¿ï¼Œ
                    æ²¡æœ‰å°†å…¶è½¬æ¢ä¸ºBlob URLå¹¶æ·»åŠ åˆ°videoçš„&lt;track&gt;å…ƒç´ ä¸­ï¼Œ
                    å› æ­¤å­—å¹•æ— æ³•æ¸²æŸ“åˆ°è§†é¢‘ç”»é¢ä¸Šã€‚
                </div>
            `;
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'success' :
                             type === 'error' ? 'error' :
                             type === 'warning' ? 'warning' : 'info';
            element.innerHTML = `<div class="test-result ${className}">${message}</div>`;
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºè¯´æ˜
        window.onload = function() {
            console.log('å­—å¹•æ¸²æŸ“æµ‹è¯•å·¥å…·å·²åŠ è½½');
        };
    </script>
</body>
</html>
